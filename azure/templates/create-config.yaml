jobs:
  - deployment: Deploy
    displayName: Create/update K8s configuration resources
    environment: $(kubernetesEnvironment)
    strategy:
      runOnce:
        deploy:
          steps:
            - checkout: self

            - task: Kubernetes@1
              displayName: Create configmap
              inputs:
                namespace: $(kubernetesNamespace)
                configurationType: configuration
                command: apply
                useConfigurationFile: true
                configuration: $(Build.SourcesDirectory)/infra/k8s/configmap.yaml

            - task: Kubernetes@1
              displayName: Create secret
              inputs:
                namespace: $(kubernetesNamespace)
                configurationType: inline
                command: apply
                useConfigurationFile: true
                inline: |
                  apiVersion: v1
                  kind: Secret
                  metadata:
                    name: giga-ingestion-portal
                    labels:
                      app: giga-ingestion-portal
                  stringData:
                    AZURE_SAS_TOKEN: "$(azureSasToken)"
                    AZURE_BLOB_CONTAINER_NAME: "$(storageContainerName)"
                    AZURE_STORAGE_ACCOUNT_NAME: "$(storageAccountName)"
                    SECRET_KEY: "$(applicationSecretKey)"
                    AZURE_APPLICATION_ID: "$(azureAdApplicationId)"
                    AZURE_TENANT_ID: "$(azureAdTenantId)"
                    VITE_AZURE_TENANT_ID: "$(azureAdTenantId)"
                    AZURE_CLIENT_ID: "$(azureAdClientId)"
                    VITE_AZURE_CLIENT_ID: "$(azureAdClientId)"
                    AZURE_CLIENT_SECRET: "$(azureAdClientSecret)"
                    AZURE_TENANT_NAME: "$(azureAdTenantName)"
                    VITE_AZURE_TENANT_NAME: "$(azureAdTenantName)"
                    AZURE_AUTH_POLICY_NAME: "$(azureAdPolicyName)"
                    VITE_AZURE_AUTH_POLICY_NAME: "$(azureAdPolicyName)"
                    AZURE_REDIRECT_URI: "$(azureAdRedirectUri)"
                    WEB_APP_REDIRECT_URI: "$(webAppHost)"
                    AZURE_EMAIL_CONNECTION_STRING: "$(azureEmailConnectionString)"
                    AZURE_EMAIL_SENDER: "$(azureEmailSender)"
                    EMAIL_RENDERER_BEARER_TOKEN: "$(emailRendererBearerToken)"
                    EMAIL_RENDERER_SERVICE_URL: "$(emailRendererServiceUrl)"
                    EMAIL_TEST_RECIPIENTS: '$(emailTestRecipients)'
                    DEPLOY_ENV: "$(deployEnv)"
                    COMMIT_SHA: "$(Build.SourceVersion)"
                    SENTRY_DSN: "$(sentryDsn)"
                    VITE_SENTRY_DSN: "$(viteSentryDsn)"
                    NODE_SENTRY_DSN: "$(nodeSentryDsn)"
                    VITE_DATAHUB_URL: "https://io-datahub-$(deployEnv).unitst.org"
